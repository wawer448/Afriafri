<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecospatial CMS - Content Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .cms-header {
            background: #2c7a7b;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .cms-header h1 {
            font-size: 1.8rem;
        }

        .cms-header p {
            opacity: 0.9;
            margin-top: 0.5rem;
        }

        .cms-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .cms-panel {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .cms-panel h2 {
            color: #2c7a7b;
            margin-bottom: 1.5rem;
            font-size: 1.4rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #444;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 5px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #2c7a7b;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .services-section {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .services-section h4 {
            color: #2c7a7b;
            margin-bottom: 1rem;
        }

        .service-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .service-item input {
            margin-bottom: 0.5rem;
        }

        .btn {
            background: #2c7a7b;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background 0.3s ease;
            margin-right: 1rem;
            margin-bottom: 1rem;
        }

        .btn:hover {
            background: #38b2ac;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .preview-frame {
            width: 100%;
            height: 600px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid #e2e8f0;
        }

        .status-message {
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            display: none;
        }

        .status-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .cms-container {
                grid-template-columns: 1fr;
                padding: 0 1rem;
            }
            
            .cms-header {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <header class="cms-header">
        <h1>üõ†Ô∏è Ecospatial CMS</h1>
        <p>Simple Content Management System - Edit your website content easily</p>
    </header>

    <div class="cms-container">
        <!-- Edit Panel -->
        <div class="cms-panel">
            <h2>üìù Edit Content</h2>
            
            <div class="status-message" id="statusMessage"></div>

            <form id="cmsForm">
                <!-- Company Info -->
                <div class="form-group">
                    <label for="companyName">Company Name</label>
                    <input type="text" id="companyName" value="Ecospatial Limited Solutions">
                </div>

                <div class="form-group">
                    <label for="tagline">Hero Tagline</label>
                    <input type="text" id="tagline" value="Professional Land Survey & Physical Planning Services">
                </div>

                <div class="form-group">
                    <label for="subtitle">Hero Subtitle</label>
                    <input type="text" id="subtitle" value="Your trusted partner in spatial solutions and land development">
                </div>

                <!-- About Section -->
                <div class="form-group">
                    <label for="aboutText1">About Text - Paragraph 1</label>
                    <textarea id="aboutText1">Ecospatial Limited Solutions is a leading land survey and physical planning consultancy firm dedicated to providing innovative spatial solutions. With years of experience in the industry, we combine cutting-edge technology with professional expertise to deliver accurate and reliable services.</textarea>
                </div>

                <div class="form-group">
                    <label for="aboutText2">About Text - Paragraph 2</label>
                    <textarea id="aboutText2">Our team of qualified surveyors and planners is committed to excellence, ensuring that every project meets the highest standards of quality and precision. We pride ourselves on our attention to detail and our ability to provide customized solutions that meet our clients' unique needs.</textarea>
                </div>

                <!-- Contact Info -->
                <div class="form-group">
                    <label for="location">Location</label>
                    <input type="text" id="location" value="Nairobi, Kenya">
                </div>

                <div class="form-group">
                    <label for="phone">Phone Number</label>
                    <input type="text" id="phone" value="+254 722 804 316">
                </div>

                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" value="pwaweru05@gmail.com">
                </div>

                <div class="form-group">
                    <label for="hours">Business Hours</label>
                    <input type="text" id="hours" value="Mon - Fri: 8:00 AM - 5:00 PM">
                </div>

                <!-- Services Section -->
                <div class="services-section">
                    <h4>üõ†Ô∏è Services</h4>
                    
                    <div class="service-item">
                        <input type="text" id="service1Title" value="Land Surveying" placeholder="Service Title">
                        <textarea id="service1Desc" placeholder="Service Description">Accurate topographical surveys, boundary surveys, and cadastral mapping using state-of-the-art equipment.</textarea>
                    </div>

                    <div class="service-item">
                        <input type="text" id="service2Title" value="Physical Planning" placeholder="Service Title">
                        <textarea id="service2Desc" placeholder="Service Description">Comprehensive urban and regional planning services for sustainable development projects.</textarea>
                    </div>

                    <div class="service-item">
                        <input type="text" id="service3Title" value="GIS Mapping" placeholder="Service Title">
                        <textarea id="service3Desc" placeholder="Service Description">Geographic Information System solutions for spatial data analysis and visualization.</textarea>
                    </div>

                    <div class="service-item">
                        <input type="text" id="service4Title" value="Property Subdivision" placeholder="Service Title">
                        <textarea id="service4Desc" placeholder="Service Description">Expert subdivision planning and approval processing for residential and commercial properties.</textarea>
                    </div>

                    <div class="service-item">
                        <input type="text" id="service5Title" value="Land Documentation" placeholder="Service Title">
                        <textarea id="service5Desc" placeholder="Service Description">Complete land documentation services including title deeds and land registration.</textarea>
                    </div>
                </div>

                <div class="action-buttons">
                    <button type="button" class="btn" onclick="updatePreview()">üîÑ Refresh Preview</button>
                    <button type="button" class="btn btn-success" onclick="saveChanges()">üíæ Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="downloadHTML()">üì• Download Updated File</button>
                    <button type="button" class="btn" onclick="updateMainFile()">üöÄ Update Main File</button>
                    <button type="button" class="btn btn-secondary" onclick="loadFromFile()">üìÇ Load from File</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">üîÑ Reset All</button>
                </div>
                
                <div style="margin-top: 1rem; padding: 1rem; background: #e8f5e8; border-radius: 5px; font-size: 0.9rem;">
                    <strong>üí° Real-time Preview:</strong> Changes appear automatically as you type (300ms delay). 
                    Use "Refresh Preview" if updates seem stuck.
                </div>
                
                <div style="margin-top: 1rem; padding: 1rem; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; font-size: 0.9rem;">
                    <strong>üöÄ Update Main File:</strong> 
                    <ol style="margin: 0.5rem 0; padding-left: 1.5rem;">
                        <li>Click "Update Main File" to generate updated version</li>
                        <li>Download will save as "ecospatial-compact.html"</li>
                        <li>Replace your original file with the downloaded one</li>
                        <li>Your website is now updated!</li>
                    </ol>
                </div>
                
                <!-- File Input for Loading -->
                <input type="file" id="fileInput" accept=".html" style="display: none;" onchange="handleFileLoad(event)">
            </form>
        </div>

        <!-- Preview Panel -->
        <div class="cms-panel">
            <h2>üëÅÔ∏è Live Preview</h2>
            <iframe id="previewFrame" class="preview-frame" src="about:blank"></iframe>
        </div>
    </div>

    <script>
        // Load saved data on page load
        window.addEventListener('load', function() {
            console.log('CMS loaded successfully');
            loadSavedData();
            updatePreview();
            setupRealTimeUpdates();
            console.log('All functions initialized');
        });

        function loadSavedData() {
            const savedData = localStorage.getItem('ecospatialCMSData');
            if (savedData) {
                const data = JSON.parse(savedData);
                Object.keys(data).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = data[key];
                    }
                });
                showStatus('Loaded saved changes', 'success');
            }
        }

        function saveChanges() {
            try {
                const formData = gatherFormData();
                localStorage.setItem('ecospatialCMSData', JSON.stringify(formData));
                showStatus('Changes saved successfully!', 'success');
                console.log('Data saved:', formData);
            } catch (error) {
                console.error('Save error:', error);
                showStatus('Error saving changes: ' + error.message, 'error');
            }
        }

        function gatherFormData() {
            const fields = [
                'companyName', 'tagline', 'subtitle', 'aboutText1', 'aboutText2',
                'location', 'phone', 'email', 'hours',
                'service1Title', 'service1Desc', 'service2Title', 'service2Desc',
                'service3Title', 'service3Desc', 'service4Title', 'service4Desc',
                'service5Title', 'service5Desc'
            ];
            
            const data = {};
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    data[field] = element.value;
                }
            });
            return data;
        }

        let updateTimeout;
        
        function setupRealTimeUpdates() {
            const fields = [
                'companyName', 'tagline', 'subtitle', 'aboutText1', 'aboutText2',
                'location', 'phone', 'email', 'hours',
                'service1Title', 'service1Desc', 'service2Title', 'service2Desc',
                'service3Title', 'service3Desc', 'service4Title', 'service4Desc',
                'service5Title', 'service5Desc'
            ];
            
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    // Use debounced updates for better performance
                    field.addEventListener('input', function() {
                        clearTimeout(updateTimeout);
                        updateTimeout = setTimeout(() => {
                            updatePreview();
                        }, 300); // 300ms delay
                    });
                }
            });
            
            console.log('Real-time updates enabled for', fields.length, 'fields');
        }

        function updatePreview() {
            console.log('updatePreview called');
            try {
                const data = gatherFormData();
                generatePreviewHTML(data);
                console.log('Preview updated successfully');
            } catch (error) {
                console.error('Preview update error:', error);
                showStatus('Error updating preview: ' + error.message, 'error');
            }
        }

        function generateHTMLContent(data) {
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${data.companyName} - Land Survey & Physical Planning</title>
    <style>
        /* Same CSS as the original compact file */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-color: #2c7a7b;
            --secondary-color: #38b2ac;
            --accent-color: #4fd1c5;
            --text-dark: #2d3748;
            --text-light: #718096;
            --bg-light: #f7fafc;
            --white: #ffffff;
            --shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            overflow-x: hidden;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        header { background: var(--white); box-shadow: var(--shadow); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; }
        .navbar { padding: 1rem 0; }
        .navbar .container { display: flex; justify-content: space-between; align-items: center; }
        .nav-brand h1 { color: var(--primary-color); font-size: 1.8rem; font-weight: 700; }
        .nav-menu { display: flex; list-style: none; gap: 2rem; }
        .nav-menu a { text-decoration: none; color: var(--text-dark); font-weight: 500; transition: color 0.3s ease; }
        .nav-menu a:hover { color: var(--primary-color); }
        .hero {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--white);
            padding: 150px 0 100px;
            text-align: center;
            margin-top: 80px;
        }
        .hero-content h2 { font-size: 3rem; margin-bottom: 1rem; font-weight: 700; }
        .hero-content p { font-size: 1.3rem; margin-bottom: 2rem; opacity: 0.9; }
        .btn { display: inline-block; padding: 12px 30px; text-decoration: none; border-radius: 5px; font-weight: 600; transition: all 0.3s ease; }
        .btn-primary { background: var(--white); color: var(--primary-color); }
        .services { padding: 80px 0; background: var(--bg-light); }
        .section-title { text-align: center; font-size: 2.5rem; margin-bottom: 3rem; color: var(--text-dark); }
        .services-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem; }
        .service-card { background: var(--white); padding: 2rem; border-radius: 10px; text-align: center; box-shadow: var(--shadow); }
        .service-icon { font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem; font-weight: bold; }
        .service-card h3 { font-size: 1.5rem; margin-bottom: 1rem; color: var(--text-dark); }
        .service-card p { color: var(--text-light); line-height: 1.8; }
        .about { padding: 80px 0; background: var(--white); }
        .about-content { max-width: 800px; margin: 0 auto; }
        .about-text p { color: var(--text-light); font-size: 1.1rem; margin-bottom: 1.5rem; line-height: 1.8; }
        .contact { padding: 80px 0; background: var(--bg-light); }
        .contact-content { display: grid; grid-template-columns: 1fr 1fr; gap: 4rem; margin-top: 3rem; }
        .contact-info h3 { font-size: 1.8rem; margin-bottom: 2rem; color: var(--text-dark); }
        .info-item { display: flex; align-items: center; margin-bottom: 1.5rem; }
        .info-icon { font-size: 1.2rem; color: var(--primary-color); width: 30px; font-weight: bold; }
        .info-item p { color: var(--text-light); font-size: 1.1rem; }
        footer { background: #2d3748; color: var(--white); padding: 40px 0; text-align: center; }
        @media (max-width: 768px) {
            .hero-content h2 { font-size: 2rem; }
            .services-grid { grid-template-columns: 1fr; }
            .contact-content { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header>
        <nav class="navbar">
            <div class="container">
                <div class="nav-brand">
                    <h1>${data.companyName}</h1>
                </div>
                <ul class="nav-menu">
                    <li><a href="#home">Home</a></li>
                    <li><a href="#services">Services</a></li>
                    <li><a href="#about">About</a></li>
                    <li><a href="#contact">Contact</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <section id="home" class="hero">
        <div class="hero-content">
            <h2>${data.tagline}</h2>
            <p>${data.subtitle}</p>
            <a href="#services" class="btn btn-primary">Explore Our Services</a>
        </div>
    </section>

    <section id="services" class="services">
        <div class="container">
            <h2 class="section-title">Our Services</h2>
            <div class="services-grid">
                <div class="service-card">
                    <div class="service-icon">üìç</div>
                    <h3>${data.service1Title}</h3>
                    <p>${data.service1Desc}</p>
                </div>
                <div class="service-card">
                    <div class="service-icon">üèôÔ∏è</div>
                    <h3>${data.service2Title}</h3>
                    <p>${data.service2Desc}</p>
                </div>
                <div class="service-card">
                    <div class="service-icon">üåç</div>
                    <h3>${data.service3Title}</h3>
                    <p>${data.service3Desc}</p>
                </div>
                <div class="service-card">
                    <div class="service-icon">üè†</div>
                    <h3>${data.service4Title}</h3>
                    <p>${data.service4Desc}</p>
                </div>
                <div class="service-card">
                    <div class="service-icon">üìÑ</div>
                    <h3>${data.service5Title}</h3>
                    <p>${data.service5Desc}</p>
                </div>
            </div>
        </div>
    </section>

    <section id="about" class="about">
        <div class="container">
            <h2 class="section-title">About ${data.companyName}</h2>
            <div class="about-content">
                <div class="about-text">
                    <p>${data.aboutText1}</p>
                    <p>${data.aboutText2}</p>
                </div>
            </div>
        </div>
    </section>

    <section id="contact" class="contact">
        <div class="container">
            <h2 class="section-title">Get In Touch</h2>
            <div class="contact-content">
                <div class="contact-info">
                    <h3>Contact Information</h3>
                    <div class="info-item">
                        <span class="info-icon">üìç</span>
                        <p>${data.location}</p>
                    </div>
                    <div class="info-item">
                        <span class="info-icon">üìû</span>
                        <p>${data.phone}</p>
                    </div>
                    <div class="info-item">
                        <span class="info-icon">‚úâÔ∏è</span>
                        <p>${data.email}</p>
                    </div>
                    <div class="info-item">
                        <span class="info-icon">üïê</span>
                        <p>${data.hours}</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <div class="container">
            <p>&copy; 2024 ${data.companyName}. All rights reserved.</p>
        </div>
    </footer>
</body>
</html>`;
        }

        function generatePreviewHTML(data) {
            const htmlContent = generateHTMLContent(data);
            
            // Update preview iframe
            const iframe = document.getElementById('previewFrame');
            
            // Method 1: Try writing directly to iframe
            try {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                iframeDoc.open();
                iframeDoc.write(htmlContent);
                iframeDoc.close();
            } catch (e) {
                // Method 2: Fallback to blob URL
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                iframe.src = url;
                
                // Clean up old blob URLs
                setTimeout(() => URL.revokeObjectURL(url), 100);
            }
        }

        function downloadHTML() {
            try {
                const data = gatherFormData();
                const htmlContent = generateHTMLContent(data);
                
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ecospatial-updated.html';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showStatus('HTML file downloaded successfully!', 'success');
                console.log('HTML downloaded successfully');
            } catch (error) {
                console.error('Download error:', error);
                showStatus('Error downloading HTML: ' + error.message, 'error');
            }
        }

        function updateMainFile() {
            try {
                const data = gatherFormData();
                const htmlContent = generateHTMLContent(data);
                
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ecospatial-compact.html'; // Same name as original
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showStatus('Updated main file ready for download! Replace your original file with this one.', 'success');
                console.log('Main file update generated');
            } catch (error) {
                console.error('Main file update error:', error);
                showStatus('Error creating main file update: ' + error.message, 'error');
            }
        }

        function loadFromFile() {
            document.getElementById('fileInput').click();
        }

        function handleFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.html')) {
                showStatus('Please select an HTML file', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const htmlContent = e.target.result;
                    parseHTMLContent(htmlContent);
                    showStatus('File loaded successfully! Content has been populated in the form.', 'success');
                } catch (error) {
                    console.error('File parse error:', error);
                    showStatus('Error parsing file: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function parseHTMLContent(htmlContent) {
            // Create a temporary DOM parser
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            
            // Extract content from the HTML
            const title = doc.querySelector('title')?.textContent || '';
            const heroH2 = doc.querySelector('.hero-content h2')?.textContent || '';
            const heroP = doc.querySelector('.hero-content p')?.textContent || '';
            
            // Extract company name from title or hero
            const companyName = title.split(' - ')[0] || 'Ecospatial Limited Solutions';
            
            // Extract about paragraphs
            const aboutParagraphs = doc.querySelectorAll('.about-text p');
            const aboutText1 = aboutParagraphs[0]?.textContent || '';
            const aboutText2 = aboutParagraphs[1]?.textContent || '';
            
            // Extract contact info
            const infoItems = doc.querySelectorAll('.info-item p');
            const location = infoItems[0]?.textContent || '';
            const phone = infoItems[1]?.textContent || '';
            const email = infoItems[2]?.textContent || '';
            const hours = infoItems[3]?.textContent || '';
            
            // Extract services
            const serviceCards = doc.querySelectorAll('.service-card');
            const services = [];
            serviceCards.forEach(card => {
                const title = card.querySelector('h3')?.textContent || '';
                const desc = card.querySelector('p')?.textContent || '';
                services.push({ title, desc });
            });
            
            // Populate form fields
            document.getElementById('companyName').value = companyName;
            document.getElementById('tagline').value = heroH2;
            document.getElementById('subtitle').value = heroP;
            document.getElementById('aboutText1').value = aboutText1;
            document.getElementById('aboutText2').value = aboutText2;
            document.getElementById('location').value = location;
            document.getElementById('phone').value = phone;
            document.getElementById('email').value = email;
            document.getElementById('hours').value = hours;
            
            // Populate services (up to 5)
            for (let i = 0; i < Math.min(services.length, 5); i++) {
                const serviceNum = i + 1;
                document.getElementById(`service${serviceNum}Title`).value = services[i].title;
                document.getElementById(`service${serviceNum}Desc`).value = services[i].desc;
            }
            
            // Update preview
            updatePreview();
            
            console.log('HTML content parsed and form populated');
        }

        function resetForm() {
            if (confirm('Are you sure you want to reset all changes?')) {
                localStorage.removeItem('ecospatialCMSData');
                location.reload();
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message status-${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>